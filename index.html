<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Map of Confirmed Cases and Deaths | San Francisco</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js"></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css" rel="stylesheet" />
  <link rel="stylesheet" media="all" href="//fonts.googleapis.com/css?family=Rubik:300,400,500,700">
  <link rel="stylesheet" media="all" href="index.css">
</head>

<body>
  <section id="visual">
    <section id="sidebar">
      <div class="sidebar__heading">
        <h1 id="dynamic_title">Map of Confirmed Cases and Deaths</h1>
        Click on the map to highlight an area for more information.
      </div>
      <div class="sidebar__content">
        <div id="dynamic_content">
          <p>The map shows the rate of confirmed COVID-19 cases calculated as the number of positive cases per 10,000 residents (all cumulative cases since testing began on March 2nd). The map initially displays the rates by neighborhood, but you can zoom in to see rates for smaller areas known as census tracts.</p>
          <h2>Rates not calculated in areas with fewer than twenty cases</h2>
          <p>Because of variability in the data, the rate of cases is not calculated for areas with fewer than twenty cases. Areas without a calculated rate of incidence are indicated on the map with a yellow crosshatch pattern. However, you may still click on a yellow crosshatched area to see the actual number of cases in that region.</p>
          <h2>Certain information dropped to protect privacy</h2>
          <p>To protect the privacy of San Francisco residents, the City does not disclose the actual number of confirmed cases for areas with fewer than ten confirmed. In addition, no case data is displayed for areas with an underlying population of fewer than 1,000 people. These areas are unshaded on the map.</p>
        </div>
      </div>
    </section>
    <div id="map"></div>
    <div class="sfgov-cta-button__container">
      <button id="fit" style="display: none;">Zoom to San Francisco</button>
    </div>
    <div class="map-overlay" id="legend">
      <h2>Cases per 10,000 residents</h2>
    </div>
  </section>
  <!-- Script for displaying a map and updating the sidebar with data from map -->
  <script>
    // specify initial layers and source
    var geomLayer = 'neighborhoods-data';
    var outlineLayers = ['neighborhoods-outline', 'census-tracts-outline'];
    var referenceLayer = 'neighborhoods-reference';
    var geomSource = 'covid19_cases-1eby22';
    // zoom threshold where first boundary switches to second - should match layer filters
    var zoomThreshold = 13;

    var initialTitle = document.getElementById('dynamic_title').innerHTML;
    var initialText = document.getElementById('dynamic_content').innerHTML;

    mapboxgl.accessToken = 'pk.eyJ1IjoiZGF0YXNmIiwiYSI6ImNrOXVzcjQ5czA1Nmkza3BrZTJ4eGg5bmgifQ.wOYqgXQmhOGDhsH3jNyP9A';
    var sfbounds = [-122.51517176651764,37.70717556431859,-122.35761922678324,37.84150802989059];

    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/datasf/ckav6d00g32uk1imp2am456qh?fresh=true',
      zoom: 11.78,
      center: [-122.43639549665045, 37.774372306273605],
      maxBounds: [-122.58758917585335,37.6769123913688,-122.2965263460861,37.86740935582834]
    });

    map.on("style.load", function () {
      var dataUrl = "https://data.sfgov.org/resource/tpyr-dvnc.geojson?$select=id,area_type,count,rate,deaths,acs_population,multipolygon&$where=area_type='Census Tract'+or+area_type='Analysis Neighborhood'";

      map.addSource("geojson", {
        type: "geojson",
        data: dataUrl
      })
      addDynamicLayerStyles();
      addInteraction();
      
      // create legend, use colors from mapbox style
      // BEWARE: array number of color ramp can change based on style ordering, must change if studio style changes
      var fillRamp = map.getPaintProperty(geomLayer, 'fill-color')[8];
      fillRamp = fillRamp.splice(2);
      var layers = fillRamp.filter((layer, idx) => idx % 2 == 1);
      var colors = fillRamp.filter((layer, idx) => idx % 2 == 0)
      for (i = 0; i < layers.length; i++) {
        var layer = layers[i] + " to " + layers[i + 1];
        if (layers[i + 1] === undefined) {
          layer = "Greater than " + layers[i];
        }
        var color = colors[i];
        var item = document.createElement('div');
        var key = document.createElement('span');
        key.className = 'legend-key';
        key.style.backgroundColor = color;
        var value = document.createElement('span');
        value.innerHTML = layer;

        item.appendChild(key);
        item.appendChild(value);
        legend.appendChild(item);
      }

      var item = document.createElement('div');
      var key = document.createElement('span');
      key.className = 'legend-key legend-key__no-rate';
      var value = document.createElement('span');
      value.innerHTML = 'Case counts too small (<20)';
      item.appendChild(key);
      item.appendChild(value);
      legend.appendChild(item);

      var item = document.createElement('div');
      var key = document.createElement('span');
      key.className = 'legend-key legend-key__no-count';
      var value = document.createElement('span');
      value.innerHTML = '0 Cases';
      item.appendChild(key);
      item.appendChild(value);
      legend.appendChild(item);

      /* Remove rotate from control
      *  Disable drag rotate
      *  Disable touch zoom rotate
      */
      map.addControl(new mapboxgl.NavigationControl({
        showCompass: false
      }));
      map.dragRotate.disable();
      map.touchZoomRotate.disableRotation();

      // add fullscreen control and target body of page
      map.addControl(new mapboxgl.FullscreenControl({container: document.querySelector('body')}))
    });

    function addDynamicLayerStyles() {
      const style = map.getStyle();
      style.sources.composite.promoteId = "id";
      const dataLayers = style.layers.filter(item => item['source-layer'] === geomSource)
      dataLayers.forEach(layer => {
        map.removeLayer(layer.id);
        layer.source = "geojson";
        delete layer["source-layer"];
        map.addLayer(layer);
      });
      style.sources.geojson.promoteId = "id";
      map.setStyle(style);

      // set selection state styles
      for (let step = 0; step < outlineLayers.length; step++) {
        map.setPaintProperty(outlineLayers[step], "line-color",
          ["case", ["==", ["feature-state", "selected"], true], "#FEB42E", "#FFFFFF"]);
        map.setPaintProperty(outlineLayers[step], "line-width",
          ["case", ["==", ["feature-state", "selected"], true], 3, 1]);
        map.setPaintProperty(outlineLayers[step], "line-offset",
          ["case", ["==", ["feature-state", "selected"], true], 1, 0]);
      }
    }

    /// update map state from latest data
    var geomIDToData = {};
    function assignFeatureStateFromData(data) {
      var features = data.features;
      for (var i = 0; i < features.length; i += 1) {
        var geom = features[i];
        geomIDToData[geom.properties.id] = geom.properties;
      }
      addInteraction();
    }

    var selectedGeom = null;
    function setSelectedGeometry(feature) {
      if (selectedGeom) {
        map.removeFeatureState({ source: "geojson", id: selectedGeom.id }, "selected");
      }
      if (selectedGeom === null || selectedGeom.id !== feature.id) {
        map.setFeatureState({ source: "geojson", id: feature.id }, { "selected": true });
        selectedGeom = feature;
        getContentForLocation(feature);
      } else {
        document.getElementById('dynamic_title').innerHTML = initialTitle
        document.getElementById('dynamic_content').innerHTML = initialText;
        selectedGeom = null;
      }
    }

    function formatNumber(num) {
      return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')
    }

    function formatCensusTract(id) {
      var tract_num = parseInt(id.substring(5, 9),10)
      var tract_sub = id.substring(9,11)
      return tract_sub == "00" ? tract_num.toString() : tract_num.toString() + '.' + tract_sub.toString();
    }

    // Returns text advice based on state status
    function getContentForLocation(geom) {
      var data = geom.properties
      var title = document.getElementById("dynamic_title");
      var output = document.getElementById("dynamic_content");
      var geomName = geom.id;
      if (data.area_type === 'Census Tract') {
        geomName = 'Census Tract ' + formatCensusTract(data.id);
      }
      title.textContent = `${geomName}`;
      var lines = "";

      // parse data from strings, catch nulls which will return NaN or undefineds where the attribute is missing
      var countText = (!isNaN(parseInt(data.count)) && typeof(data.count) !== "undefined") ? parseInt(data.count) : "fewer than 10";
      var deathsText = !isNaN(parseInt(data.deaths)) ? parseInt(data.deaths) : "fewer than 10";
      var rate = !isNaN(parseFloat(data.rate)) && typeof(data.rate) != "undefined" ? parseFloat(data.rate) : null;
      // all acs_populations should be populated, not catching NaN or undefined
      var acs_population = parseInt(data.acs_population);
      if (acs_population < 1000) {
        lines += `<p>Data dropped for ${geomName} because the estimated population is less than 1,000</p>`
      } else {
        if (typeof(countText) === "string" || countText < 20 || rate === null) {
          lines += `<p>Rates are not calculated for ${geomName} because the case counts are fewer than 20.</p>`;
        } else {
          lines += `<p>This area has an estimated rate of <strong>${rate.toFixed(1)} positive cases per 10,000 residents</strong>.</p>`;
        }
        lines += `<p>There are <strong>${countText} positive cases</strong> among a resident <strong>population of about ${formatNumber(acs_population)}</strong>.`;
        // enter logic to cast undefined to 0 deaths
        lines += `<p>Out of the ${countText} positive cases, <strong>${deathsText} individuals have died</strong>.`;
      }
      /*lines += `<p>[OPTIONAL AREA SPECIFIC INFORMATION HERE, for example: This area contains a shelter with a recent outbreak. The City is working to transfer all affected individuals into the appropriate medical care facility based on their needs. More information on the Cityâ€™s response here: [LINK].]</p>`;*/
      lines += `<h2>San Francisco offering help to residents</h2>`;
      lines += `<p>San Francisco is offering a variety of resources to support residents, such as childcare for essential workers, help for residents needing access to food, and financial assistance for small businesses. For information about all the resources available, visit <a href="https://sf.gov/coronavirus">sf.gov/coronavirus</a> or call 311.</p>`;
      lines += `<h3>Getting tested</h3>`;
      lines += `<p>There are options for getting tested for COVID-19 in San Francisco for the uninsured and insured. <a href="https://sf.gov/find-out-how-get-tested-coronavirus">Learn more about how you can access testing</a>.</p>`;

      assignFeatureStateFromData
      output.innerHTML = lines;
    };

    // Change geomLayer on zoom, show/hide zoom to san francisco button
    map.on('zoom', function () {
      if (map.getZoom() > 12) {
        document.getElementById('fit').style.display = 'block';
      } else {
        document.getElementById('fit').style.display = 'none';
      }
      if (map.getZoom() >= zoomThreshold && geomLayer == 'neighborhoods-data') {
        removeInteraction();
        geomLayer = 'census-tracts-data';
        addInteraction();
      } else if (map.getZoom() < zoomThreshold && geomLayer == 'census-tracts-data') {
        removeInteraction();
        geomLayer = 'neighborhoods-data';
        addInteraction();
      }
    })

    // Show tooltip popop so user knows they can double click to see more
    var popup = new mapboxgl.Popup({
      anchor: 'left',
      offset: 30,
      closeButton: false
    })

    map.on('mousemove', 'neighborhoods-data', function (e) {
      map.getCanvas().style.cursor = 'pointer';
      popup
        .setLngLat(e.lngLat)
        .setHTML('Click to select, double click to zoom to ' + e.features[0].properties.id)
        .addTo(map);
    });

    map.on('mouseleave', 'neighborhoods-data', function (e) {
      map.getCanvas().style.cursor = '';
      popup.remove();
    })

    // Zoom polygon extents on double click, disable double click to zoom
    map.on('dblclick', 'neighborhoods-data', function (e) {
      map.doubleClickZoom.disable();
      var bounds = turf.extent(e.features[0].geometry);
      map.fitBounds(bounds);
    })

    // On zoom end re-enable double click to zoom
    map.on('zoomend', function(e){
      map.doubleClickZoom.enable();
    })

    function addInteraction() {
      map.on('click', geomLayer, onClickCallback);
    }

    function removeInteraction() {
      map.off('click', geomLayer, onClickCallback);
    }

    function onClickCallback(event) {
      var geometry = event.features[0];
      setSelectedGeometry(geometry);
    }

    document.getElementById('fit').addEventListener('click', function () {
      map.fitBounds(sfbounds);
    });
  </script>

</body>

</html>