<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Display a map</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            width: 640px;
            height: 480px;
            display: block;
            flex: 0 1 auto;
        }

        #textOutput {
            flex-grow: 1;
        }

        #visual {
            width: 100vw;
            display: flex;
            flex-direction: row;
        }
    </style>
</head>

<body>
    <section id="visual">
        <div id="map"></div>
        <section id="textOutput"></section>
    </section>
    <!-- script for loading data from CSV -->
    <!-- we use XMLHttpRequest to maintain maximum backward compatibility -->
    <script>
        /// Read CSV data published by domestic team from `source`
        /// Parses CSV for the requested `fields`. `fields` is an object where the key is
        /// the output key and the value is the expected column name in the data.
        /// Calls `callback` with parsed data when successfully complete.
        /// If there is an error, calls `errorHandler` instead.
        function loadCSV(source, fields, callback, errorHandler) {
            var request = new XMLHttpRequest();
            request.open("GET", source);
            request.onreadystatechange = function (event) {
                if (request.readyState === XMLHttpRequest.DONE) {
                    try {
                        var text = request.responseText;
                        var entries = parseCSVForFields(text, fields);
                        if (callback) {
                            callback(entries);
                        }
                    } catch (err) {
                        console.error(err);
                        if (errorHandler) {
                            errorHandler(err);
                        }
                    }
                }
            };

            request.send();
        }

        /// Parse CSV data and return array of objects with requested fields
        function parseCSVForFields(text, fields) {
            var lines = text.split("\n");
            var sep = ",";

            var keyIndices = parseHeader(lines[0], fields);

            if (keyIndices.some(function (v) { return v.index === -1; })) {
                throw (new Error("Heading format for data has changed. Please update this page to expect new data format."))
            }

            var entries = [];
            for (var i = 1; i < lines.length; i += 1) {
                if (lines[i].length === 0) {
                    continue;
                }
                var pieces = lines[i].split(sep);
                var obj = keyIndices.reduce(function (collection, keyIndex) {
                    collection[keyIndex.key] = pieces[keyIndex.index].trim();
                    return collection;
                }, {});
                entries.push(obj);
            }
            return entries;
        }

        function parseHeader(row, fields) {
            var sep = ",";
            var headings = row.split(sep).map(function (heading) { return heading.trim(); });
            return Object.keys(fields).map(function (key) {
                return { key: key, index: headings.indexOf(fields[key]) };
            });
        }
    </script>
    <!-- Script for displaying a map and updating the sidebar with data from map -->
    <script>
        // TODO: add your access token
        mapboxgl.accessToken = 'pk.eyJ1IjoiZGF2aWQtd2lja3MiLCJhIjoiY2s5dHlwNzE5MWF4bjNtbXJhbGV1bjQ2NiJ9.fvifwhaQ_Y-x9AknEkTsYQ';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/david-wicks/ck9uah3qf0sxh1io4pf13fa46',
            zoom: 3.25,
            center: [0, 0],
            maxZoom: 10,
            maxBounds: [
                [-40, -35],
                [40, 35]
            ]
        });

        map.on("style.load", function () {
            addDynamicStateLayerStyles();
            // load data from a url, then pass it to assignFeatureStateFromData
            // TODO: point to your production data
            var stateLevelDataURL = "./mock-states.csv";
            loadCSV(stateLevelDataURL,
                { name: "name", abbreviation: "id", riskLevel: "number_of_interest", population: "population" },
                assignFeatureStateFromData);
        });

        function addDynamicStateLayerStyles() {
            // promote id from albers so we can join our data
            var style = map.getStyle();
            // TODO: if you are using counties, you will also need to promote a
            // county-level id for joining on feature-state
            style.sources.composite.promoteId = "state_abbrev";
            map.setStyle(style);

            map.setPaintProperty("state-boundaries", "line-color",
                ["case", ["==", ["feature-state", "selected"], true], "#FEB42E", "#fff"]);
            map.setPaintProperty("state-boundaries", "line-width",
                ["case", ["==", ["feature-state", "selected"], true], 3, 1])
            map.setPaintProperty("state-boundaries", "line-offset",
                ["case", ["==", ["feature-state", "selected"], true], 1, 0]);
            // color gradation based on 'level' value
            var expression = ["interpolate",
                ["linear"],
                ["feature-state", "level"],
                0, "#72E6E2",
                1, "#30678D",
            ];
            map.setPaintProperty("states", "fill-color", expression);
        }

        /// update map state from latest data
        var stateIDToData = {};
        function assignFeatureStateFromData(data) {
            for (var i = 0; i < data.length; i += 1) {
                var state = data[i];
                // assign `level` feature state
                var normalizedLevel = parseFloat(state.riskLevel) / 1000000;
                map.setFeatureState({ source: "composite", sourceLayer: "albersusa", id: state.abbreviation }, { level: normalizedLevel });
                stateIDToData[state.abbreviation] = state;
            }
            addStateInteraction();
        }

        function addStateInteraction() {
            // Handle clicks on states to load information
            map.on("click", "states", function (event) {
                var state = event.features[0];
                setSelectedState(state);
            });
        }

        var selectedState = null;
        function setSelectedState(feature) {
            if (selectedState) {
                map.removeFeatureState({ source: "composite", sourceLayer: "albersusa", id: selectedState.id }, "selected");
            }
            map.setFeatureState({ source: "composite", sourceLayer: "albersusa", id: feature.id }, { "selected": true });
            selectedState = feature;
            showSidebarForLocation(selectedState.id);
        }

        function showSidebarForLocation(stateID) {
            var output = document.getElementById("textOutput");
            output.textContent = getTextContentForLocation(stateID);
        }

        // Returns text advice based on state status
        function getTextContentForLocation(stateID) {
            // TODO: craft your messages for different risk levels
            // You can special-case different states by their stateID,
            // which is simply their two-letter abbreviation, like "NY"
            var state = stateIDToData[stateID];
            return "Risk level for " + state.name + " is " + state.riskLevel;
        }
    </script>

</body>

</html>