<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Map of Confirmed Cases and Deaths | San Francisco</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js"></script>
  <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css" rel="stylesheet" />
  <link rel="stylesheet" media="all" href="//fonts.googleapis.com/css?family=Rubik:300,400,500,700">
  <link rel="stylesheet" media="all" href="index.css">
</head>

<body>
  <section id="visual">
    <div id="map"></div>
    <div class="sfgov-cta-button__container">
      <button id="fit" style="display: none;">Zoom to San Francisco</button>
    </div>
    <div class="map-overlay" id="legend">
      <h2>Cases per 10,000 residents</h2>
    </div>
    <section id="sidebar">
      <div class="sidebar__heading">
        <h1 id="dynamic_title">Map of Confirmed Cases and Deaths</h1>
        Click on the map to highlight an area for more information.
      </div>
      <div class="sidebar__content">
        <div id="dynamic_content">
          <p>The map shows the rate of confirmed COVID-19 cases calculated as the number of positive cases per 10,000 residents (all cumulative cases since testing began on March 2nd). The map initially displays the rates by neighborhood, but you can zoom in to see them for smaller areas known as census tracts.</p>
          <h2>Rates not calculated in areas with fewer than twenty cases</h2>
          <p>Because of variability in the data, the rate of cases is not calculated for areas with fewer than twenty cases. Areas without a calculated rate of incidence are indicated on the map with a yellow crosshatch pattern. However, you may still click on a yellow crosshatched area to see the actual number of cases in that region.</p>
          <h2>Certain information dropped to protect privacy</h2>
          <p>To protect the privacy of San Francisco residents, the City does not disclose the actual number of confirmed cases for areas with fewer than ten confirmed. In addition, no case data is displayed for areas with an underlying population of fewer than 1,000 people. These areas are unshaded on the map.</p>
        </div>
      </div>
    </section>
  </section>
  <!-- script for loading data from CSV -->
  <!-- we use XMLHttpRequest to maintain maximum backward compatibility -->
  <script>
    /// Read CSV data published by domestic team from `source`
    /// Parses CSV for the requested `fields`. `fields` is an object where the key is
    /// the output key and the value is the expected column name in the data.
    /// Calls `callback` with parsed data when successfully complete.
    /// If there is an error, calls `errorHandler` instead.
    function loadCSV(source, fields, callback, errorHandler) {
      var request = new XMLHttpRequest();
      request.open("GET", source);
      request.onreadystatechange = function (event) {
        if (request.readyState === XMLHttpRequest.DONE) {
          try {
            var text = request.responseText;
            var entries = parseCSVForFields(text, fields);
            if (callback) {
              callback(entries);
            }
          } catch (err) {
            console.error(err);
            if (errorHandler) {
              errorHandler(err);
            }
          }
        }
      };

      request.send();
    }

    /// Parse CSV data and return array of objects with requested fields
    function parseCSVForFields(text, fields) {
      var lines = text.split("\n");
      var sep = ",";

      var keyIndices = parseHeader(lines[0], fields);
      if (keyIndices.some(function (v) { return v.index === -1; })) {
        throw (new Error("Heading format for data has changed. Please update this page to expect new data format."))
      }

      var entries = [];
      for (var i = 1; i < lines.length; i += 1) {
        if (lines[i].length === 0) {
          continue;
        }
        var pieces = lines[i].split(sep);
        var obj = keyIndices.reduce(function (collection, keyIndex) {
          collection[keyIndex.key] = pieces[keyIndex.index].trim();
          return collection;
        }, {});
        entries.push(obj);
      }
      return entries;
    }

    function parseHeader(row, fields) {
      var sep = ",";
      var headings = row.split(sep).map(function (heading) { return heading.trim(); });
      return Object.keys(fields).map(function (key) {
        return { key: key, index: headings.indexOf(fields[key]) };
      });
    }
  </script>
  <!-- Script for displaying a map and updating the sidebar with data from map -->
  <script>
    // specify initial layers and source
    var geomLayer = 'neighborhoods-data';
    var outlineLayers = ['neighborhoods-outline', 'census-tracts-outline'];
    var referenceLayer = 'neighborhoods-reference';
    var geomSource = 'covid19_cases-1eby22';
    // zoom threshold where first boundary switches to second - should match layer filters
    var zoomThreshold = 13;

    var initialTitle = document.getElementById('dynamic_title').innerHTML;
    var initialText = document.getElementById('dynamic_content').innerHTML;

    mapboxgl.accessToken = 'pk.eyJ1IjoiZGF0YXNmIiwiYSI6ImNrOXVzcjQ5czA1Nmkza3BrZTJ4eGg5bmgifQ.wOYqgXQmhOGDhsH3jNyP9A';
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/datasf/ckav6d00g32uk1imp2am456qh?fresh=true',
      zoom: 11.5,
      center: [-122.402964, 37.767043],
      maxBounds: [[-122.53777492130767, 37.6794833964247], [-122.28178000000041, 37.847049047064274]]
    });

    map.on("style.load", function () {
      var dataUrl = "./covid19_cases.geojson";

      map.addSource("geojson", {
        type: "geojson",
        data: dataUrl
      })
      addDynamicLayerStyles();
      // load data from a url, then pass it to assignFeatureStateFromData
      // TODO: point to your production data
      var fillRamp = map.getPaintProperty(geomLayer, 'fill-color')[6];
      fillRamp = fillRamp.splice(2);
      var layers = fillRamp.filter((layer, idx) => idx % 2 == 1);
      var colors = fillRamp.filter((layer, idx) => idx % 2 == 0)
      for (i = 0; i < layers.length; i++) {
        var layer = layers[i] + " to " + layers[i + 1];
        if (layers[i + 1] === undefined) {
          layer = "Greater than " + layers[i];
        }
        var color = colors[i];
        var item = document.createElement('div');
        var key = document.createElement('span');
        key.className = 'legend-key';
        key.style.backgroundColor = color;
        var value = document.createElement('span');
        value.innerHTML = layer;

        item.appendChild(key);
        item.appendChild(value);
        legend.appendChild(item);
      }

      var item = document.createElement('div');
      var key = document.createElement('span');
      key.className = 'legend-key legend-key__no-rate';
      var value = document.createElement('span');
      value.innerHTML = 'Counts too small (<20)';

      item.appendChild(key);
      item.appendChild(value);
      legend.appendChild(item);

      

      fetch(dataUrl)
        .then(function (response) {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(assignFeatureStateFromData);

      /*loadCSV(dataUrl,
        { id: "geoid10", rate: "cntpop", population: "Pop", count: "FREQUENCY" },
        assignFeatureStateFromData);*/

      /* Remove rotate from control
      *  Disable drag rotate
      *  Disable touch zoom rotate
      */
      map.addControl(new mapboxgl.NavigationControl({
        showCompass: false
      }));
      map.dragRotate.disable();
      map.touchZoomRotate.disableRotation();
    });

    function addDynamicLayerStyles() {
      // promote id from albers so we can join our data
      const style = map.getStyle();
     // const dataLayer = style.layers.find(item => item['source-layer'] === geomSource)
     // dataLayer.source = "geojson"
      // TODO: if you are using counties, you will also need to promote a
      // county-level id for joining on feature-state
      // TODO: change this identifier to match final
      style.sources.composite.promoteId = "id";
      map.setStyle(style);
      for (let step = 0; step < outlineLayers.length; step++) {
        map.setPaintProperty(outlineLayers[step], "line-color",
          ["case", ["==", ["feature-state", "selected"], true], "#FEB42E", "#FFFFFF"]);
        map.setPaintProperty(outlineLayers[step], "line-width",
          ["case", ["==", ["feature-state", "selected"], true], 3, 1]);
        map.setPaintProperty(outlineLayers[step], "line-offset",
          ["case", ["==", ["feature-state", "selected"], true], 1, 0]);
      }
    }

    /// update map state from latest data
    var geomIDToData = {};
    function assignFeatureStateFromData(data) {
      var features = data.features;
      for (var i = 0; i < features.length; i += 1) {
        var geom = features[i];
        geomIDToData[geom.properties.id] = geom.properties;
      }
      addInteraction();
    }

    var selectedGeom = null;
    function setSelectedGeometry(feature) {
      if (selectedGeom) {
        map.removeFeatureState({ source: "composite", sourceLayer: geomSource, id: selectedGeom.id }, "selected");
      }
      if (selectedGeom === null || selectedGeom.id !== feature.id) {
        map.setFeatureState({ source: "composite", sourceLayer: geomSource, id: feature.id }, { "selected": true });
        selectedGeom = feature;
        getContentForLocation(feature.id);
      } else {
        document.getElementById('dynamic_title').innerHTML = initialTitle
        document.getElementById('dynamic_content').innerHTML = initialText;
        selectedGeom = null;
      }
    }

    function formatNumber(num) {
      return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,')
    }

    // Returns text advice based on state status
    function getContentForLocation(geomId) {
      var geom = geomIDToData[geomId];
      var title = document.getElementById("dynamic_title");
      var output = document.getElementById("dynamic_content");
      var geomName = geomId;
      if (geom.area_type === 'Census Tract') {
        geomName = 'Census Tract ' + geomId.substring(5, 11)
      }
      title.textContent = `${geomName}`;
      var lines = "";

      // this will be in the dataset, so no counts below 10 should be in the underlying data
      var count = geom.count;
      console.log(geom.count)
      if ((geom.count < 10 || geom.count == null)) {
        count = "fewer than 10"
      }
      if ((geom.deaths < 10 || geom.deaths == null)) {
        deaths = "fewer than 10"
      }
      if (geom.acs_population < 1000) {
        lines += `<p>Data dropped for ${geomName} because the estimated population is less than 1,000</p>`
      } else {
        if (geom.count < 20) {
          lines += `<p>Rates are not calculated for ${geomName} because the case counts are fewer than 20.</p>`;
        } else {
          lines += `<p>This area has an estimated rate of <strong>${geom.rate.toFixed(1)} positive cases per 10,000 residents</strong>.</p>`;
        }
        lines += `<p>There are <strong>${count} positive cases</strong> among a resident <strong>population of about ${formatNumber(geom.acs_population)}</strong>.`;
        // enter logic to cast undefined to 0 deaths
        lines += `<p>Out of the ${count} positive cases, <strong>[DEATHS] individuals have died</strong>.`;
      }
      /*lines += `<p>[OPTIONAL AREA SPECIFIC INFORMATION HERE, for example: This area contains a shelter with a recent outbreak. The City is working to transfer all affected individuals into the appropriate medical care facility based on their needs. More information on the City’s response here: [LINK].]</p>`;*/
      lines += `<h2>San Francisco offering assistance to residents</h2>`;
      lines += `<p>San Francisco is offering a variety of resources to support residents, such as childcare for essential workers, help for residents needing access to food, and financial assistance for small businesses. For information about all the resources available, visit <a href="https://sf.gov/coronavirus">sf.gov/coronavirus</a> or call 311.</p>`;
      lines += `<h3>Getting tested</h3>`;
      lines += `<p>There are options for getting tested for COVID-19 in San Francisco for the uninsured and insured. <a href="https://sf.gov/find-out-how-get-tested-coronavirus">Learn more about how you can access testing</a>.</p>`;

      /*
      lines.push(`There are [COUNT] confirmed cases among a resident population of about [POP].`);
      lines.push(`Out of the [COUNT] confirmed cases, [DEATHS] individuals have died.`);
      lines.push();
      lines.push(`This data does not mean that any area of the city is more or less safe than any other area. All San Franciscans are strongly advised to continue taking all precautions to protect themselves and others (including staying home as much as possible, wearing a face covering, and staying at least 6 feet away from others).`);
      lines.push(`San Francisco is offering a variety of resources to support residents, such as childcare for essential workers, help for residents needing access to food, and financial assistance for small businesses. For information about all the resources available, visit www.SF.gov/coronavirus or call 311.`);
      lines.push(`The dashboard below shows the data from the map in a table format. Just like in the map, all census tracts with resident populations of less than [CONFIRM NUMBER], and any census tract with fewer than [CONFIRM NUMBER] confirmed cases are omitted in order to protect privacy. As more cases are confirmed, the dashboard will be updated.`)
      lines.push(`The figures are updated daily and data are added as more information becomes available.`)
      output.innerHTML = "";
      let paras = lines.map(line => {
        let para = document.createElement('P');
        para.innerHTML = line;
        return para;
      }).reduce((acc, curr) => output.appendChild(curr));*/assignFeatureStateFromData
      output.innerHTML = lines;
    };

    // Change geomLayer on zoom, show/hide zoom to san francisco button
    map.on('zoom', function () {
      if (map.getZoom() > 12) {
        document.getElementById('fit').style.display = 'block';
      } else {
        document.getElementById('fit').style.display = 'none';
      }
      if (map.getZoom() >= zoomThreshold && geomLayer == 'neighborhoods-data') {
        removeInteraction();
        geomLayer = 'census-tracts-data';
        addInteraction();
      } else if (map.getZoom() < zoomThreshold && geomLayer == 'census-tracts-data') {
        removeInteraction();
        geomLayer = 'neighborhoods-data';
        addInteraction();
      }
    })

    // Show tooltip popop so user knows they can double click to see more
    var popup = new mapboxgl.Popup({
      anchor: 'left',
      offset: 30,
      closeButton: false
    })

    map.on('mousemove', 'neighborhoods-data', function (e) {
      map.getCanvas().style.cursor = 'pointer';
      popup
        .setLngLat(e.lngLat)
        .setHTML('Click to select, double click to zoom to ' + e.features[0].properties.id)
        .addTo(map);
    });

    map.on('mouseleave', 'neighborhoods-data', function (e) {
      map.getCanvas().style.cursor = '';
      popup.remove();
    })

    // Zoom polygon extents on double click, disable double click to zoom
    map.on('dblclick', 'neighborhoods-data', function (e) {
      map.doubleClickZoom.disable();
      var bounds = turf.extent(e.features[0].geometry);
      map.fitBounds(bounds);
    })

    // On zoom end re-enable double click to zoom
    map.on('zoomend', function(e){
      map.doubleClickZoom.enable();
    })

    function addInteraction() {
      map.on('click', geomLayer, onClickCallback);
    }

    function removeInteraction() {
      map.off('click', geomLayer, onClickCallback);
    }

    function onClickCallback(event) {
      var geometry = event.features[0];
      setSelectedGeometry(geometry);
    }

    document.getElementById('fit').addEventListener('click', function () {
      map.fitBounds([
        [-122.53777492130766, 37.67948339642544],
        [-122.28178000000045, 37.847049047064985]
      ]);
    });
  </script>

</body>

</html>